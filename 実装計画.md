# J-SOX RCM情報抽出AIエージェント 実装計画

## 前提条件

## 技術スタック

- **バックエンド**: Python, Pandas, Langchain
- **フロントエンド**: Streamlit
- **AI/LLM**: OpenAI API GPT-5

## フェーズ1: コア機能開発 (MVP)

### 目的
まずは単一のファイルをアップロードし、AIと対話しながら手動でルールを確定させ、CSVをダウンロードできる基本バージョンを完成させます。

### バックエンド (データ処理層)

#### ファイル入出力
- [x] Excelファイル (.xlsx, .xls) のアップロードを受け付けるUIを作成する。
- [x] CSVファイル (.csv) のアップロードを受け付けるUIを作成する。
- [x] アップロードされたファイルの先頭10行をLLMに渡し、ヘッダー行を特定させ、Pandas DataFrameとして読み込む処理を実装する。ヘッダー行は複合している場合も想定する。
- [x] 処理結果をCSV形式でダウンロードできるようにする。
- [x] アップロードファイルの処理結果はst.sessionに保存し、保存されている限りはヘッダー行特定のLLM処理が流れないようにする。
- [x] ファイルが再アップロードされたらst.sessionをクリアする。

#### LLM連携
- [x] LLM API (OpenAI) と通信するための基本モジュールを実装する。
- [x] APIキーは画面上で入力できるようにする。
- [x] LLMの結果はstructured outputで型安全に取得できるようにする。
- [x] エラーになった場合はフォールバックせず、エラー詳細を画面に表示させる。

#### データ処理ロジック (初回解析)
- [x] 構造理解: DataFrameのヘッダーとデータ数行をLLMに渡し、カラムのラベルを推論させるプロンプトを設計・実装する。
- [x] ラベルはリスク、コントロール、手続、前回の手続結果の4つの選択肢で、該当しないものはその他を割り当てる。
- [x] ルール適用: 生成されたカラムとラベルの紐づけをルール案と呼び、ルール案に基づき、DataFrameを加工・整形する関数を実装する。
- [x] 同一ラベルに複数カラムが紐づく場合は、JSONで構造化する。

### フロントエンド (UI層)

#### 基本画面
- [x] ファイルをアップロードするためのUI (ドラッグ＆ドロップ対応が望ましい) を作成する。
- [x] 処理中であることがわかるローディングインジケーターを実装する。

#### 対話・修正インターフェース
- [x] AIが生成したルール案を分かりやすく表示するコンポーネントを作成する。
- [x] ユーザーが各カラムの役割（リスク、コントロール等）をプルダウンメニューで修正できる機能を実装する。
- [x] 修正したルールを適用した結果がプレビューできるテーブル表示機能を実装する。

#### 操作
- [x] 最終的なルールをバックエンドに送信する「承認」ボタンを実装する。
- [x] 処理結果をダウンロードするための「CSVダウンロード」ボタンを実装する。

## フェーズ2: パターン学習機能の開発

### 目的
MVPに「参照型パターン」の仕組みを導入します。過去の処理内容を記憶し、AIの推論を補助することで、2回目以降の処理を高速化・高精度化します。

### バックエンド (学習・推論層)

#### パターンデータベース(DB)
- [x] 承認済みパターンを保存するためのデータベースを設計・構築する (json or yaml)。
- [x] テーブルスキーマを定義する (パターンID, パターン名, ファイル特徴, 抽出ルールJSONなど)。

#### パターン保存・更新
- [x] ユーザーによる「承認」時、確定した抽出ルールと、そのRCMの特徴（カラム名リストなど）をDBに保存/更新するAPIを実装する。

#### 類似パターン検索
- [x] 新規ファイル入力時、その特徴をLLMに要約させる処理を実装する。
- [x] 要約された特徴を基に、DBから意味的に最も類似するパターンを検索するロジックを実装する (LLMを活用した検索)。

#### 推論補助ロジック
- [x] 検索でヒットした類似パターンを「ヒント」としてLLMのプロンプトに組み込む処理を実装する。

### フロントエンド (UI層)

#### フィードバック表示
- [x] 類似パターンが見つかった場合に、「過去の "XXX" パターンを参考に提案を作成しました」といった通知を表示する機能を実装する。

#### パターン管理（オプション）
- [ ] 保存されているパターンの一覧を表示する管理画面を作成する。
- [ ] パターンに分かりやすい名前（例: "A監査法人向けフォーマット"）を付けたり、不要なパターンを削除したりする機能を実装する。

## フェーズ3: UI/UXの高度化と運用機能

### 目的
実務での利用を想定し、より使いやすく、安定して動作するための周辺機能を充実させます。

### フロントエンド & バックエンド

#### 一括処理機能
- [ ] 複数のファイルを一度にアップロードできるUIを実装する。
- [ ] 全ファイルの処理結果を一覧で表示し、個別にまたはまとめてダウンロードできる機能を実装する。

#### 内部監査業務を前提とした各手続の理解
- [x] 内部監査業務の観点から、各行を精査する仕組みを実装する。
- [x] 各行を独立して参照するのではなく、全体像を把握したうえで精査できる仕組みを考える。例えば、同一リスク、コントロールのデータにフィルタリングして処理するなど。
- [x] 1行に複数の手続が包含されるような場合は適切に行分割する。
- [x] 不要行であれば削除するなど、クレンジングをする。
- [x] 各手続きに対して、証跡の数（大中小）、手続の難易度（難中易）、手続の種類（整備/運用）の判定を行い、構造化する。

